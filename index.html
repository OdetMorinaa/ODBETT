<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OdBett</title>
<style>
/* Reset and Global Styles */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background-color: white;
color: #2ecc71;
line-height: 1.6;
}

/* Container and Layout */
.container {
max-width: 1200px;
margin: 0 auto;
padding: 10px;
}

/* Header */
.header {
background-color: #2ecc71;
color: white;
padding: 15px 20px;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.logo {
font-size: 1.8rem;
font-weight: bold;
}

.user-info {
font-size: 1rem;
}

/* Hidden Class */
.hidden {
display: none;
}

/* Panels */
.panel {
background: white;
border: 1px solid #2ecc71;
border-radius: 8px;
margin: 20px 0;
overflow: hidden;
box-shadow: 0 2px 10px rgba(46, 204, 113, 0.1);
}

.panel-header {
background-color: #2ecc71;
color: white;
padding: 12px 15px;
font-size: 1.1rem;
font-weight: 600;
}

.panel-body {
padding: 15px;
}

/* Forms */
.form-group {
margin-bottom: 15px;
}

label {
display: block;
margin-bottom: 5px;
font-weight: 500;
}

input, select, button {
width: 100%;
padding: 10px;
border: 1px solid #2ecc71;
border-radius: 5px;
font-size: 1rem;
}

input:focus, select:focus {
outline: none;
border-color: #27ae60;
box-shadow: 0 0 5px rgba(46, 204, 113, 0.3);
}

button {
background-color: #2ecc71;
color: white;
border: none;
cursor: pointer;
font-weight: 600;
transition: background 0.3s;
margin-top: 5px;
}

button:hover {
background-color: #27ae60;
}

/* Button Types */
.btn-danger {
background-color: #e74c3c;
}

.btn-danger:hover {
background-color: #c0392b;
}

/* Tables */
.table {
width: 100%;
border-collapse: collapse;
margin: 15px 0;
}

.table th, .table td {
padding: 12px;
text-align: left;
border-bottom: 1px solid #eee;
}

.table th {
background-color: #2ecc71;
color: white;
}

.table tr:hover {
background-color: #f8f8f8;
}

/* Cards */
.card {
border: 1px solid #2ecc71;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
background: white;
}

.card-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}

/* Balance Display */
.balance {
font-size: 1.2rem;
font-weight: 600;
color: #2ecc71;
text-align: center;
padding: 15px;
background-color: #f9f9f9;
border: 1px solid #2ecc71;
border-radius: 8px;
margin: 15px 0;
}

/* Flex Layout */
.flex {
display: flex;
gap: 10px;
}

.flex-1 { flex: 1; }
.flex-2 { flex: 2; }
.flex-3 { flex: 3; }

/* Responsive Design */
@media (max-width: 768px) {
.flex {
flex-direction: column;
}

.header {
flex-direction: column;
text-align: center;
gap: 10px;
}

.user-info {
order: -1;
}

.table th, .table td {
padding: 8px;
font-size: 0.9rem;
}

input, button {
font-size: 0.95rem;
}
}

/* Login Form */
.login-container {
max-width: 400px;
margin: 50px auto;
padding: 30px;
border: 2px solid #2ecc71;
border-radius: 10px;
text-align: center;
}

.login-container h1 {
margin-bottom: 20px;
color: #2ecc71;
}

.error {
color: #e74c3c;
margin: 10px 0;
font-weight: 600;
}

/* Bet Buttons */
.bet-button {
background-color: #2ecc71;
color: white;
border: none;
padding: 8px 12px;
margin: 2px;
border-radius: 4px;
cursor: pointer;
font-size: 0.9rem;
}

/* Status Badges */
.status {
padding: 3px 8px;
border-radius: 12px;
font-size: 0.8rem;
font-weight: 600;
}

.status-pending {
background-color: #f39c12;
color: white;
}

.status-won {
background-color: #27ae60;
color: white;
}

.status-lost {
background-color: #e74c3c;
color: white;
}
</style>
</head>
<body>
<!-- Header -->
<div class="header">
<div class="logo">OdBett</div>
<div class="user-info" id="userInfo">Guest</div>
</div>

<!-- Login View -->
<div class="login-container" id="loginView">
<h1>Welcome</h1>
<form id="loginForm">
<div class="form-group">
<input type="text" id="username" placeholder="Username" required />
</div>
<div class="form-group">
<input type="password" id="password" placeholder="Password" required />
</div>
<button type="submit">Log In</button>
<div id="errorMessage" class="error hidden"></div>
</form>
</div>

<!-- Admin View -->
<div id="adminView" class="container hidden">
<!-- User Management -->
<div class="panel">
<div class="panel-header">User Management</div>
<div class="panel-body">
<!-- Create User -->
<form id="createUserForm" class="flex">
<div class="form-group flex-1">
<input type="text" id="newUsername" placeholder="Username" required />
</div>
<div class="form-group flex-1">
<input type="password" id="newPassword" placeholder="Password" required />
</div>
<div class="form-group flex-1">
<button type="submit">Create User</button>
</div>
</form>

<!-- Add Points -->
<form id="addPointsForm" class="flex">
<div class="form-group flex-1">
<input type="text" id="targetUser" placeholder="Username" required />
</div>
<div class="form-group flex-1">
<input type="number" id="pointsAmount" placeholder="Amount" min="1" required />
</div>
<div class="form-group flex-1">
<button type="submit">Add Points</button>
</div>
</form>

<!-- Users List -->
<h3>All Users</h3>
<table class="table">
<thead>
<tr>
<th>Username</th>
<th>BetPoints</th>
</tr>
</thead>
<tbody id="usersList"></tbody>
</table>
</div>
</div>

<!-- Game Management -->
<div class="panel">
<div class="panel-header">Game Management</div>
<div class="panel-body">
<!-- Add Game -->
<form id="addGameForm" class="flex">
<div class="form-group flex-1">
<input type="text" id="gameTitle" placeholder="Game Title" required />
</div>
<div class="form-group flex-1">
<input type="text" id="team1" placeholder="Team 1" required />
</div>
<div class="form-group flex-1">
<input type="number" id="odds1" placeholder="Odds 1" step="0.01" min="1" required />
</div>
<div class="form-group flex-1">
<input type="text" id="team2" placeholder="Team 2" required />
</div>
<div class="form-group flex-1">
<input type="number" id="odds2" placeholder="Odds 2" step="0.01" min="1" required />
</div>
<div class="form-group flex-1">
<button type="submit">Add Game</button>
</div>
</form>

<!-- Games List -->
<h3>Active Games</h3>
<div id="gamesList"></div>
</div>
</div>

<button id="adminLogout" class="btn-danger" style="width: 100%;">Log Out</button>
</div>

<!-- User View -->
<div id="userView" class="container hidden">
<div class="balance" id="userBalance">BetPoints: 0</div>

<!-- Games List -->
<div class="panel">
<div class="panel-header">Available Games</div>
<div class="panel-body">
<div id="userGamesList"></div>
</div>
</div>

<!-- Bet History -->
<div class="panel">
<div class="panel-header">Bet History</div>
<div class="panel-body">
<table class="table">
<thead>
<tr>
<th>Game</th>
<th>Team</th>
<th>Amount</th>
<th>Odds</th>
<th>Payout</th>
<th>Status</th>
</tr>
</thead>
<tbody id="betHistory"></tbody>
</table>
</div>
</div>

<button id="userLogout" class="btn-danger" style="width: 100%;">Log Out</button>
</div>
<script>
// DOM Elements
const loginView = document.getElementById('loginView');
const adminView = document.getElementById('adminView');
const userView = document.getElementById('userView');
const userInfo = document.getElementById('userInfo');
const errorMessage = document.getElementById('errorMessage');
const userBalance = document.getElementById('userBalance');
const usersList = document.getElementById('usersList');
const gamesList = document.getElementById('gamesList');
const userGamesList = document.getElementById('userGamesList');
const betHistory = document.getElementById('betHistory');

// Form Elements
const loginForm = document.getElementById('loginForm');
const createUserForm = document.getElementById('createUserForm');
const addPointsForm = document.getElementById('addPointsForm');
const addGameForm = document.getElementById('addGameForm');
const adminLogout = document.getElementById('adminLogout');
const userLogout = document.getElementById('userLogout');

// Input Elements
const username = document.getElementById('username');
const password = document.getElementById('password');
const newUsername = document.getElementById('newUsername');
const newPassword = document.getElementById('newPassword');
const targetUser = document.getElementById('targetUser');
const pointsAmount = document.getElementById('pointsAmount');
const gameTitle = document.getElementById('gameTitle');
const team1 = document.getElementById('team1');
const odds1 = document.getElementById('odds1');
const team2 = document.getElementById('team2');
const odds2 = document.getElementById('odds2');

// Current logged-in user
let currentUser = null;
let isAdmin = false;

// ------------------- API Helper Functions --------------------

// Fetch all users
async function getUsers() {
  const res = await fetch('/api/users');
  if (!res.ok) throw new Error('Failed to fetch users');
  return await res.json();
}

// Fetch all games
async function getGames() {
  const res = await fetch('/api/games');
  if (!res.ok) throw new Error('Failed to fetch games');
  return await res.json();
}

// Fetch all bets
async function getBets() {
  const res = await fetch('/api/bets');
  if (!res.ok) throw new Error('Failed to fetch bets');
  return await res.json();
}

// Save updated users - in this model, use PUT for single user update
async function updateUser(user) {
  const res = await fetch(`/api/users/${encodeURIComponent(user.username)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(user),
  });
  return res.ok;
}

// Add new user
async function addUser(username, password) {
  const res = await fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password, points: 0 }),
  });
  if (res.ok) return true;
  if (res.status === 409) return false; // Conflict - user exists
  throw new Error('Failed to add user');
}

// Add points to user
async function addPointsToUser(username, amount) {
  try {
    const users = await getUsers();
    const user = users.find(u => u.username === username);
    if (!user) return false;
    user.points += parseInt(amount, 10);
    return await updateUser(user);
  } catch {
    return false;
  }
}

// Create new game
async function createGame(title, team1, team2, odds1, odds2) {
  const res = await fetch('/api/games', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title,
      team1,
      team2,
      odds1: parseFloat(odds1),
      odds2: parseFloat(odds2),
      result: null,
    }),
  });
  if (!res.ok) throw new Error('Failed to create game');
  return await res.json();
}

// Delete user
async function deleteUser(username) {
  const res = await fetch(`/api/users/${encodeURIComponent(username)}`, {
    method: 'DELETE',
  });
  return res.ok;
}

// Delete game
async function deleteGame(gameId) {
  const res = await fetch(`/api/games/${gameId}`, { method: 'DELETE' });
  return res.ok;
}

// Place a bet
async function placeBet(username, gameId, team, amount, odds) {
  try {
    const users = await getUsers();
    const user = users.find(u => u.username === username);
    if (!user || user.points < amount) return false;

    // Deduct points locally first
    user.points -= amount;
    const userUpdated = await updateUser(user);
    if (!userUpdated) return false;

    // Create bet
    const res = await fetch('/api/bets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username,
        gameId,
        team,
        amount,
        odds,
        status: 'pending',
      }),
    });
    return res.ok;
  } catch {
    return false;
  }
}

// Resolve game
async function resolveGame(gameId, winner) {
  try {
    // Fetch games & bets
    const games = await getGames();
    const gameIndex = games.findIndex(g => g.id === gameId);
    if (gameIndex === -1 || games[gameIndex].result !== null) return false;

    // Update game result
    games[gameIndex].result = winner;

    // Update game on server
    const resGameUpdate = await fetch(`/api/games/${gameId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(games[gameIndex]),
    });
    if (!resGameUpdate.ok) return false;

    const bets = await getBets();

    // Update bets status
    for (const bet of bets) {
      if (bet.gameId === gameId) {
        if (bet.team === winner && bet.status === 'pending') {
          bet.status = 'won';
          // Update user points for winnings
          const users = await getUsers();
          const user = users.find(u => u.username === bet.username);
          if (user) {
            user.points += bet.amount * bet.odds;
            await updateUser(user);
          }
        } else if (bet.status === 'pending') {
          bet.status = 'lost';
        }

        // Update each bet on server (assuming endpoint exists)
        await fetch(`/api/bets/${bet.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bet),
        });
      }
    }
    return true;
  } catch {
    return false;
  }
}

// ------------------- UI Display & Logic --------------------

// Display all users in admin panel
async function displayUsers() {
  try {
    const users = await getUsers();
    usersList.innerHTML = '';

    users.forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${user.username}</td>
        <td>${user.points}</td>
        <td>${user.username === 'Odii01' ? '' : `<button class="delete-user-btn" data-username="${user.username}">Delete</button>`}</td>`;
      usersList.appendChild(tr);
    });

    // Add event listeners for delete buttons
    const deleteButtons = document.querySelectorAll('.delete-user-btn');
    deleteButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const usernameToDelete = button.getAttribute('data-username');
        if (confirm(`Are you sure you want to delete user "${usernameToDelete}"?`)) {
          await deleteUser(usernameToDelete);
          await displayUsers();
          await populateUserDropdown(); // Refresh dropdown in add points form
        }
      });
    });
  } catch (err) {
    alert('Failed to load users.');
  }
}

// Display all games in admin panel with resolution and delete controls
async function displayGames() {
  try {
    const games = await getGames();
    gamesList.innerHTML = '';

    if (games.length === 0) {
      gamesList.innerHTML = '<p>No games available.</p>';
      return;
    }

    games.forEach(game => {
      const gameCard = document.createElement('div');
      gameCard.className = 'card';

      let resultText = 'Pending';
      if (game.result === 1) resultText = `${game.team1} won`;
      if (game.result === 2) resultText = `${game.team2} won`;

      gameCard.innerHTML =
        `<div class="card-header">
          <strong>${game.title}</strong>
          <span>Status: ${resultText}</span>
        </div>
        <div>
          <strong>${game.team1}</strong> (${game.odds1}) vs
          <strong>${game.team2}</strong> (${game.odds2})
        </div>`;

      // Add resolution buttons if pending
      if (game.result === null) {
        const resolveDiv = document.createElement('div');
        resolveDiv.style.marginTop = '10px';
        resolveDiv.innerHTML =
          `<button class="bet-button" data-game="${game.id}" data-winner="1">${game.team1} wins</button>
          <button class="bet-button" data-game="${game.id}" data-winner="2">${game.team2} wins</button>`;
        gameCard.appendChild(resolveDiv);

        resolveDiv.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', async () => {
            const gameId = btn.getAttribute('data-game');
            const winner = parseInt(btn.getAttribute('data-winner'));
            if (await resolveGame(gameId, winner)) {
              alert(`Game resolved: ${winner === 1 ? game.team1 : game.team2} wins!`);
              await displayGames();
              if (currentUser) await displayUserBets();
            } else {
              alert('Failed to resolve game.');
            }
          });
        });
      }

      // Delete game button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete Game';
      deleteBtn.style.marginTop = '10px';
      deleteBtn.addEventListener('click', async () => {
        if (confirm(`Are you sure you want to delete the game "${game.title}"?`)) {
          if (await deleteGame(game.id)) {
            await displayGames();
            if (currentUser) await displayUserBets();
          } else {
            alert('Failed to delete game.');
          }
        }
      });
      gameCard.appendChild(deleteBtn);

      gamesList.appendChild(gameCard);
    });
  } catch {
    gamesList.innerHTML = '<p>Error loading games.</p>';
  }
}

// Display games for user betting
async function displayUserGames() {
  try {
    const games = await getGames();
    userGamesList.innerHTML = '';

    if (games.length === 0) {
      userGamesList.innerHTML = '<p>No games available for betting.</p>';
      return;
    }

    games.forEach(game => {
      if (game.result !== null) return; // Skip resolved games

      const gameCard = document.createElement('div');
      gameCard.className = 'card';

      gameCard.innerHTML =
        `<div class="card-header">
          <strong>${game.title}</strong>
        </div>
        <div style="margin: 10px 0;">
          <button class="bet-button" data-game="${game.id}" data-team="1" data-odds="${game.odds1}">
            ${game.team1} (${game.odds1})
          </button>
          <button class="bet-button" data-game="${game.id}" data-team="2" data-odds="${game.odds2}">
            ${game.team2} (${game.odds2})
          </button>
        </div>`;

      userGamesList.appendChild(gameCard);
    });

    // Add event listeners for placing bets
    const betButtons = userGamesList.querySelectorAll('.bet-button');
    betButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const gameId = btn.getAttribute('data-game');
        const team = parseInt(btn.getAttribute('data-team'));
        const odds = parseFloat(btn.getAttribute('data-odds'));
        const amountStr = prompt('Enter bet amount:');
        const amount = parseInt(amountStr);

        if (isNaN(amount) || amount <= 0) {
          alert('Invalid bet amount.');
          return;
        }
        if (currentUser.points < amount) {
          alert('Insufficient points.');
          return;
        }

        if (await placeBet(currentUser.username, gameId, team, amount, odds)) {
          alert('Bet placed successfully!');
          await refreshCurrentUser();
          updateUserInfo();
          await displayUserBets();
        } else {
          alert('Failed to place bet.');
        }
      });
    });
  } catch {
    userGamesList.innerHTML = '<p>Error loading games.</p>';
  }
}

// Display bets of current user
async function displayUserBets() {
  try {
    const bets = await getBets();
    const games = await getGames();
    betHistory.innerHTML = '';

    const userBets = bets.filter(bet => bet.username === currentUser.username);
    if (userBets.length === 0) {
      betHistory.innerHTML = '<p>No bets placed yet.</p>';
      return;
    }

    userBets.forEach(bet => {
      const game = games.find(g => g.id === bet.gameId);
      if (!game) return;

      const betDiv = document.createElement('div');
      betDiv.className = 'card';
      let statusText = 'Pending';
      if (bet.status === 'won') statusText = 'Won 🎉';
      else if (bet.status === 'lost') statusText = 'Lost ❌';

      const teamName = bet.team === 1 ? game.team1 : game.team2;

      betDiv.innerHTML =
        `<strong>${game.title}</strong><br>
        Bet on: ${teamName} <br>
        Amount: ${bet.amount} points<br>
        Odds: ${bet.odds}<br>
        Status: ${statusText}`;

      betHistory.appendChild(betDiv);
    });
  } catch {
    betHistory.innerHTML = '<p>Error loading bets.</p>';
  }
}

// Refresh current user data from server
async function refreshCurrentUser() {
  try {
    const users = await getUsers();
    currentUser = users.find(u => u.username === currentUser.username);
  } catch {
    // fail silently
  }
}

// Update user info display
function updateUserInfo() {
  userInfo.textContent = `Logged in as: ${currentUser.username}`;
  userBalance.textContent = `Balance: ${currentUser.points} points`;
}

// Populate user dropdown for admin add points form
async function populateUserDropdown() {
  try {
    const users = await getUsers();
    targetUser.innerHTML = '';
    users.forEach(user => {
      const opt = document.createElement('option');
      opt.value = user.username;
      opt.textContent = user.username;
      targetUser.appendChild(opt);
    });
  } catch {
    // do nothing
  }
}

// ------------------- Event Handlers --------------------

loginForm.addEventListener('submit', async e => {
  e.preventDefault();
  errorMessage.textContent = '';

  const uname = username.value.trim();
  const pwd = password.value;

  if (!uname || !pwd) {
    errorMessage.textContent = 'Please enter username and password.';
    return;
  }

  try {
    const users = await getUsers();
    const user = users.find(u => u.username === uname);

    if (!user || user.password !== pwd) {
      errorMessage.textContent = 'Invalid username or password.';
      return;
    }

    currentUser = user;
    isAdmin = uname === 'Odii01';

    if (isAdmin) {
      loginView.classList.add('hidden');
      adminView.classList.remove('hidden');
      await displayUsers();
      await displayGames();
      await populateUserDropdown();
    } else {
      loginView.classList.add('hidden');
      userView.classList.remove('hidden');
      updateUserInfo();
      await displayUserGames();
      await displayUserBets();
    }

    username.value = '';
    password.value = '';
  } catch {
    errorMessage.textContent = 'Error communicating with server.';
  }
});

createUserForm.addEventListener('submit', async e => {
  e.preventDefault();
  errorMessage.textContent = '';

  const uname = newUsername.value.trim();
  const pwd = newPassword.value;

  if (!uname || !pwd) {
    errorMessage.textContent = 'Please enter username and password.';
    return;
  }

  if (uname.length < 3 || pwd.length < 3) {
    errorMessage.textContent = 'Username and password must be at least 3 characters.';
    return;
  }

  try {
    const success = await addUser(uname, pwd);
    if (!success) {
      errorMessage.textContent = 'Username already exists.';
      return;
    }

    await displayUsers();
    await populateUserDropdown();
    newUsername.value = '';
    newPassword.value = '';
  } catch {
    errorMessage.textContent = 'Failed to create user.';
  }
});

addPointsForm.addEventListener('submit', async e => {
  e.preventDefault();
  errorMessage.textContent = '';

  const selectedUser = targetUser.value;
  const amount = parseInt(pointsAmount.value);

  if (!selectedUser || isNaN(amount) || amount <= 0) {
    errorMessage.textContent = 'Please select a user and enter a valid amount.';
    return;
  }

  try {
    const success = await addPointsToUser(selectedUser, amount);
    if (!success) {
      errorMessage.textContent = 'Failed to add points.';
      return;
    }
    await displayUsers();
    await populateUserDropdown();
    pointsAmount.value = '';
  } catch {
    errorMessage.textContent = 'Failed to add points.';
  }
});

addGameForm.addEventListener('submit', async e => {
  e.preventDefault();
  errorMessage.textContent = '';

  const titleVal = gameTitle.value.trim();
  const t1 = team1.value.trim();
  const t2 = team2.value.trim();
  const o1 = parseFloat(odds1.value);
  const o2 = parseFloat(odds2.value);

  if (!titleVal || !t1 || !t2 || isNaN(o1) || isNaN(o2) || o1 <= 1 || o2 <= 1) {
    errorMessage.textContent = 'Please enter valid game and odds.';
    return;
  }

  try {
    await createGame(titleVal, t1, t2, o1, o2);
    await displayGames();

    gameTitle.value = '';
    team1.value = '';
    team2.value = '';
    odds1.value = '';
    odds2.value = '';
  } catch {
    errorMessage.textContent = 'Failed to add game.';
  }
});

adminLogout.addEventListener('click', () => {
  currentUser = null;
  isAdmin = false;
  adminView.classList.add('hidden');
  loginView.classList.remove('hidden');
});

userLogout.addEventListener('click', () => {
  currentUser = null;
  userView.classList.add('hidden');
  loginView.classList.remove('hidden');
});
</script>

</body>
</html>